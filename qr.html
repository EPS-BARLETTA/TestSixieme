<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="manifest" href="manifest.webmanifest">
<title>TestSixième — QR</title>
<style>
html,body{height:100%;margin:0}
body{display:flex;align-items:center;justify-content:center;background:#ffffff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif}
.wrap{display:flex;flex-direction:column;align-items:center;gap:16px}
#qrimg{display:block;width:420px;height:420px;image-rendering:pixelated}
.topbar{position:fixed;top:12px;left:50%;transform:translateX(-50%);} .topbar a{padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc;color:#0b1324;text-decoration:none;margin-right:8px}
.tools{display:flex;gap:10px;justify-content:center}
.btn{padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc;color:#0b1324;text-decoration:none;cursor:pointer}
.msg{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b1324;color:#fff;padding:10px 14px;border-radius:12px;display:none}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script defer src="https://unpkg.com/qrcode-js-package@1.0.4/qrcode.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head><body>
<div class="topbar">
  <a href="menu.html">Retour Menu</a>
  <a href="#" onclick="resetAll();return false;">Réinitialiser le groupe</a>
</div>
<div class="wrap">
  <div id="qrHolder"><img id="qrimg" alt="QR"/></div>
  <div class="tools">
    <button id="dl" class="btn">Télécharger PNG</button>
    <button id="copy" class="btn">Copier JSON</button>
  </div>
</div>
<div class="msg" id="msg">Complétez d’abord les 3 tests pour les 2 élèves.</div>
<script>
const KEY='ts6e.duo'; const KEY_SEC='ts6e.secRead';
function ensure(){let d; try{d=JSON.parse(localStorage.getItem(KEY)||'null')}catch{d=null}
  if(!d){d={eleves:[{Nom:'',Prenom:'',Classe:'',Sexe:''},{Nom:'',Prenom:'',Classe:'',Sexe:''}],tests:{Endurance:[null,null],Saut:[null,null],Vitesse:[null,null]}}; localStorage.setItem(KEY,JSON.stringify(d));}
  return JSON.parse(localStorage.getItem(KEY));
}
function vmaFrom(i){const d=ensure(); const t=d.tests.Endurance[i]; return t && t.vma_kmh!=null ? t.vma_kmh : (t&&t.palier!=null? +(8.0+0.5*t.palier).toFixed(1):0);}
function bestLongueur(i){const d=ensure(); const t=d.tests.Saut[i]; return t && t.best_cm!=null ? t.best_cm : 0;}
function vitesseFrom(i){const d=ensure(); const t=d.tests.Vitesse[i]; return t && t.t_30m_s!=null ? t.t_30m_s : 0;}
function bothIdent(){const d=ensure(); return [0,1].every(i=>{const e=d.eleves[i]; return e.Nom&&e.Prenom&&e.Classe&&e.Sexe});}
function allHaveResults(){ const d=ensure();
  const okEnd=[0,1].every(i=>{const t=d.tests.Endurance[i]; return t && ((t.vma_kmh>0)||(t.palier>0));});
  const okSaut=[0,1].every(i=>{const t=d.tests.Saut[i]; return t && (t.best_cm>0);});
  const okVit=[0,1].every(i=>{const t=d.tests.Vitesse[i]; return t && (t.t_30m_s>0);});
  return okEnd && okSaut && okVit;
}
function payload(){ const d=ensure();
  const E=(i)=>{
    const e=d.eleves[i]||{}; const tE=d.tests.Endurance[i]||{}; const tS=d.tests.Saut[i]||{}; const tV=d.tests.Vitesse[i]||{};
    const pal = tE.palier||0;
    const nav = tE.navette||0;
    const vma = (tE.vma_kmh!=null) ? Math.round(tE.vma_kmh*10)/10 : (pal? Math.round((8.0+0.5*pal)*10)/10 : 0);
    const saut = (tS.best_cm!=null) ? Math.round(tS.best_cm) : 0;
    const vit  = (tV.t_30m_s!=null) ? Math.round(tV.t_30m_s*100)/100 : 0;
    return {
      "nom": e.Nom || "",
      "prenom": e.Prenom || "",
      "classe": e.Classe || "",
      "sexe": e.Sexe || "",
      "Palier": pal,
      "Navette": nav,
      "VMA": vma,
      "Saut en longueur": saut,
      "Vitesse 30m": vit
    };
  };
  return [E(0),E(1)];
}

function makeQR(text){
  function drawLocal(){ try{ if(typeof QRCode==='undefined') return false; const holder=document.getElementById('qrHolder'); holder.innerHTML=''; const d=document.createElement('div'); holder.appendChild(d); new QRCode(d,{text:text,width:420,height:420,correctLevel:QRCode.CorrectLevel.L}); return true;}catch(e){ return false; } }
  function drawRemote(){ var url = "https://chart.googleapis.com/chart?chs=420x420&cht=qr&chld=L|0&chl=" + encodeURIComponent(text); const img=document.getElementById('qrimg'); img.src=url; }
  if(!drawLocal()){ let waited=0; const ti=setInterval(function(){ waited+=100; if(drawLocal()){ clearInterval(ti);} else if(waited>=2500){ clearInterval(ti); drawRemote(); } },100); }
}

function downloadPNG(){
  const canvas = document.querySelector('#qrHolder canvas');
  if(canvas){ const url = canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='TestSixieme_QR.png'; a.click(); }
}
function copyJSON(){
  const data = JSON.stringify(payload());
  navigator.clipboard && navigator.clipboard.writeText(data).then(()=>alert('JSON copié.')).catch(()=>alert('JSON :\n'+data));
}

document.addEventListener('DOMContentLoaded', ()=>{
  if(localStorage.getItem(KEY_SEC)!=='1'){ alert('Lire la fiche sécurité'); location.href='securite.html'; return; }
  if(!bothIdent()){ alert('Compléter l’identité des 2 élèves'); location.href='identite.html'; return; }
  if(!allHaveResults()){ const m=document.getElementById('msg'); m.style.display='block'; setTimeout(()=>{ location.href='menu.html'; }, 1500); return; }
  const data = JSON.stringify(payload());
  makeQR(data);
  document.getElementById('dl').onclick=downloadPNG;
  document.getElementById('copy').onclick=copyJSON;
});
</script>
</body></html>